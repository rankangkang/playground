# ä»useEffectç¥è§hookså·¥ä½œæœºåˆ¶

## å‰è¨€

ç”¨äº†è¿™ä¹ˆä¹…çš„react hooksï¼Œå†™äº†å‡ ä¸ªåº”ç”¨ï¼Œå®ƒä»¬éƒ½æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œç”šè‡³å·¥ä½œå¾—å¾ˆå¥½ã€‚

è¿™å¾ˆå¥½ï¼Œä½†æ˜¯åœ¨å½“æˆ‘ä½¿ç”¨`useEffect`æ—¶ï¼Œæ€»è§‰å¾—æœ‰ç‚¹ä¸å¾—åŠ²å„¿ï¼Œæ€»è§‰å¾—æœ‰äº›åœ°æ–¹å¾ˆè¿·æƒ‘ï¼Œæ¯”å¦‚ï¼š

* å¦‚ä½•ä½¿ç”¨`useEffect`æ¨¡æ‹Ÿ`componentDidMount`ç”Ÿå‘½å‘¨æœŸï¼Ÿ**ğŸ¤”**
* å¦‚ä½•ä¼˜é›…åœ°åœ¨`useEffect`å†…è¯·æ±‚æ•°æ®å‘¢ï¼Ÿä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä¼šå‡ºç°æ— é™è¯·æ±‚çš„æƒ…å†µï¼Ÿ**ğŸ¤”**
* æˆ‘æœ‰å¿…è¦æŠŠæ‰€æœ‰åœ¨effecté‡Œç”¨åˆ°çš„æ•°æ®åŠ åˆ°ä¾èµ–ä¹ˆï¼Ÿ**ğŸ¤”**
* æˆ‘åº”è¯¥æŠŠå‡½æ•°å½“ä½œ`useEffect`ä¾èµ–ä¹ˆï¼Ÿ**ğŸ¤”**
* ä¸ºä»€ä¹ˆæœ‰æ—¶å€™åœ¨`useEffect`é‡Œæ‹¿åˆ°äº†æ—§çš„æ•°æ®ï¼Ÿ(æ˜æˆ‘åˆšåˆš`setXxx`)**ğŸ¤”**
* `useEffect`å’Œ`useLayuoutEffect`çš„ç›¸æ¯”æµè§ˆå™¨æ¸²æŸ“çš„ç¡®åˆ‡æ‰§è¡Œæ—¶æœºåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ**ğŸ¤”**
* effectåœ¨ä»€ä¹ˆæ—¶é—´ç‚¹æ¸…ç†ï¼Ÿ**ğŸ¤”**
* ...

åœ¨å¾ˆé•¿çš„ä¸€æ®µæ—¶é—´å†…ï¼Œæˆ‘æ·±å—ä»¥ä¸Šé—®é¢˜çš„å›°æ‰°ã€‚åœ¨æˆ‘é˜…è¯»Dançš„[useEffect å®Œæ•´æŒ‡å—](https://overreacted.io/zh-hans/a-complete-guide-to-useeffect/)åï¼Œæˆ‘ä¸ç¦æƒŠå‘¼â€ç´¢å˜šæ–¯å†…~â€œã€‚

æˆ‘è®°æ€§ä¸å¥½ï¼Œæ‰€ä»¥æˆ‘æƒ³æŠŠè¿™äº›â€ç´¢å˜šæ–¯å†…â€œè®°å½•ä¸‹æ¥ï¼Œä»¥ä¾›æ—¥åç¿»é˜…ã€‚

å¤§å®¶ä¹Ÿå¯åˆ°Dançš„åšå®¢å»çœ‹[åŸæ–‡](https://overreacted.io/zh-hans/a-complete-guide-to-useeffect/)ï¼Œå†™å¾—ååˆ†è¯¦ç»†ã€‚

å¦‚æœä½ æ—¶é—´ç´§è¿«ï¼Œä¹Ÿå¯ç›´æ¥åˆ°[è¿™é‡Œ](#å°è¯•å›ç­”æˆ‘ä»¬çš„é—®é¢˜)æŸ¥çœ‹è§£ç­”ã€‚

## å¿˜æ‰ä½ å·²ç»å­¦åˆ°çš„

å½“æˆ‘ä»¬é™·å…¥ä¸€ä¸ªé—®é¢˜è®¸ä¹…è€Œæ— æ³•è§£ç­”æ—¶ï¼Œæœ€å¥½åŠæ³•å¾€å¾€æ˜¯è·³è„±å‡ºæ¥ï¼Œä»¥ä¸åŒçš„è§†è§’å†æ¬¡å°è¯•ã€‚

è¿™ä¸ªé“ç†åŒæ ·é€‚ç”¨äºå¯¹`useEffect`çš„ç†è§£â€”â€”**æ”¾å¼ƒä»classç”Ÿå‘½å‘¨æœŸçš„è§’åº¦å»ç†è§£`useEffect`ï¼Œå¿˜æ‰ä½ å·²ç»å­¦åˆ°çš„çŸ¥è¯†**ã€‚

## ç±»ä¼¼â€åˆ‡ç‰‡â€œçš„æ¸²æŸ“

è¿™é‡Œçš„â€åˆ‡ç‰‡â€œä¸åŒäºå…¶ä»–çš„ç¼–ç¨‹è¯­è¨€ä¸­çš„åˆ‡ç‰‡ï¼ˆé¢å‘åˆ‡ç‰‡ç¼–ç¨‹ç­‰ï¼‰ã€‚

*ä½ å¯ä»¥æŠŠæ•´ä¸ªåº”ç”¨æƒ³è±¡æˆä¸€ä¸ªåœŸè±†ï¼Œreactæ˜¯ä¸€æŠŠåˆ€ï¼Œæ¯ä¸€æ¬¡æ¸²æŸ“éƒ½æ˜¯åˆ€åˆ‡å‰²åœŸè±†åå½¢æˆçš„ä¸€ç‰‡ã€‚*

> * æ¯ä¸€æ¬¡æ¸²æŸ“éƒ½æœ‰å®ƒè‡ªå·±çš„propsä¸state
> * æ¯ä¸€æ¬¡æ¸²æŸ“éƒ½æœ‰å®ƒè‡ªå·±çš„äº‹ä»¶å¤„ç†å‡½æ•°
> * æ¯ä¸€æ¬¡æ¸²æŸ“éƒ½æœ‰å®ƒè‡ªå·±çš„effects

Dançš„åšå®¢ä¸­å¦‚æ˜¯è¯´ã€‚ä½ å¯ä»¥æŠŠprops/stateã€äº‹ä»¶å¤„ç†å‡½æ•°å’Œeffectsç­‰è¿™äº›æ•°æ®ï¼Œè§†ä½œåœŸè±†ç‰‡ä¸Šçš„ç‰©è´¨ã€‚å½“åˆ‡å‰²ï¼ˆæ¸²æŸ“ï¼‰è¿™ä¸ªåŠ¨ä½œå®Œæˆä¹‹åï¼Œåˆ‡ç‰‡ä¸Šçš„æ‰€æœ‰ç‰©è´¨ï¼ˆæ•°æ®ï¼‰éƒ½å·²ä¸å˜ã€‚

æƒ³è¦ç†è§£ä¸Šé¢è¿™äº›è¯ï¼Œæˆ‘ä»¬å¿…é¡»éªŒè¯ä¸€ä¸‹æ¸²æŸ“ã€‚

### props/state

```jsx
function Counter() {
  const [count, setCount] = useState(0); // <--
  return (
    <div>
      <p>You clicked {count} times</p> {/* <-- */}
      <button onClick={() => setCount(count + 1)}>
        Click me
      </button>
    </div>
  );
}
```

é’ˆå¯¹ä¸Šè¿°ç®­å¤´æŒ‡å‘ä»£ç ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€ç›´è§‰æ˜¯`count`å€¼è¢«ç›‘å¬ï¼Œåœ¨æ”¹å˜æ—¶è§†å›¾è‡ªåŠ¨æ›´æ–°ã€‚

ä½†äº‹å®å¹¶éè¿™æ ·ï¼Œ`count`ä»…æ˜¯ä¸€ä¸ªæ•°å­—è€Œå·²ï¼Œä¸æ˜¯ç±»ä¼¼äº`Vue`çš„â€data-bindingâ€œã€â€watcherâ€œã€â€proxyâ€œæˆ–å…¶ä»–ç­‰ç­‰ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªæ™®æ™®é€šé€šçš„æ•°å­—ï¼Œå°±å¦‚åŒä¸‹é¢çš„ä»£ç ï¼š

```jsx
const count = 42; // <--
// ...
<p>You clicked {count} times</p> {/* <-- */}
// ...
```

ç»„ä»¶æ¸²æŸ“çš„è¿‡ç¨‹å¯ä»¥ç†è§£ä¸ºå¦‚ä¸‹çš„å½¢å¼ï¼š

```jsx
// ç¬¬ä¸€æ¬¡æ¸²æŸ“
function Counter() {
  const count = 0; // Returned by useState()
  // ...
  <p>You clicked {count} times</p>
  // ...
}

// ç‚¹å‡»è¿‡åçš„ç¬¬äºŒæ¬¡æ¸²æŸ“
function Counter() {
  const count = 1; // Returned by useState()
  // ...
  <p>You clicked {count} times</p>
  // ...
}

// å†æ¬¡ç‚¹å‡»çš„ç¬¬ä¸‰æ¬¡æ¸²æŸ“
function Counter() {
  const count = 2; // Returned by useState()
  // ...
  <p>You clicked {count} times</p>
  // ...
}
```

>  **åœ¨çŠ¶æ€æ›´æ–°çš„æ—¶å€™ï¼ŒReactéƒ½ä¼šé‡æ–°æ¸²æŸ“ç»„ä»¶ã€‚æ¯ä¸€æ¬¡æ¸²æŸ“éƒ½èƒ½æ‹¿åˆ°ç‹¬ç«‹çš„çŠ¶æ€ï¼Œå®ƒä»¬çš„å€¼æ˜¯å‡½æ•°ä¸­çš„ä¸€ä¸ªå¸¸é‡ï¼Œåœ¨ä¸€æ¬¡æ¸²æŸ“ä¸­ä¸å¯å˜ã€‚**

æ‰€ä»¥ï¼Œ`count`å°±æ˜¯ä¸€ä¸ªç®€ç®€å•å•çš„ã€æ²¡æœ‰åšä»»ä½•æ•°æ®ç»‘å®šæˆ–ç›‘å¬çš„æ•°æ®ã€‚

Reactåšçš„ä»…ä»…æ˜¯åœ¨æ¸²æŸ“æ˜¯æ’å…¥äº†`count`(ä½œä¸ºå€¼)è¿™ä¸ªæ•°æ®ã€‚å½“çŠ¶æ€æ”¹å˜ï¼ˆ`setCount`ï¼‰æ—¶ï¼Œreactä¼šå¸¦ç€æ”¹ç¼–åçš„å€¼å†æ¬¡è°ƒç”¨ç»„ä»¶ï¼ˆå°†`count`ä½œä¸ºå€¼æ’å…¥ï¼‰ã€‚ç„¶åReactæ›´æ–°DOMã€‚

> * ä»»æ„ä¸€æ¬¡æ¸²æŸ“ä¸­çš„æ•°æ®éƒ½ä¸ä¼šéšç€æ—¶é—´æ”¹å˜ã€‚
>
> * æ¸²æŸ“è¾“å‡ºçš„å˜åŒ–æ˜¯ç”±äºç»„ä»¶çš„ä¸€æ¬¡æ¬¡è°ƒç”¨å¼•èµ·çš„ã€‚
>
> * æ¯ä¸€æ¬¡æ¸²æŸ“åŒ…å«çš„æ•°æ®ç‹¬ç«‹äºå…¶ä»–ã€‚

---

### äº‹ä»¶å¤„ç†å‡½æ•°

```jsx
function Counter() {
  const [count, setCount] = useState(0);

  function handleAlertClick() {
    setTimeout(() => {
      alert('You clicked on: ' + count);
    }, 3000);
  }

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>
        Click me
      </button>
      <button onClick={handleAlertClick}>
        Show alert
      </button>
    </div>
  );
}
```

ä»¥ä¸Šä»£ç çš„ç»„ä»¶ï¼ŒæŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤æ“ä½œï¼š

* ç‚¹å‡»`Click me`å¢åŠ åˆ°3
* ç‚¹å‡»`Show alert`
* åœ¨3så†…ç‚¹å‡»`Click me`å¢åŠ åˆ°5

é‚£æ€ä¹ˆå®šæ—¶å™¨ç»“æŸåçš„`alert`ä¼šæ˜¾ç¤ºå‡ å‘¢ï¼Ÿ3ï¼ˆç‚¹å‡»æ—¶çŠ¶æ€ï¼‰è¿˜æ˜¯5ï¼ˆå®æ—¶çŠ¶æ€ï¼‰ï¼Ÿ

---

å¦‚æœä½ æ‹¿ä¸å®šä¸»æ„ï¼Œç°åœ¨å°±å»è¯•è¯•å‘—~~

---

â€”â€”ç­”æ¡ˆæ˜¯ 3 ã€‚

åŸå› ä»[ä¸Šæ–‡](###props/state)ä¾¿å¯ç¥è§ã€‚æ¯ä¸€æ¬¡æ¸²æŸ“éƒ½ä¼šæœ‰ä»–è‡ªå·±çš„propså’Œstateï¼Œä»–ä»¬æ˜¯ä¸å˜çš„ï¼Œalertä¼šâ€æ•è·â€œå®ƒä»¬ã€‚è¢«æ•è·æ—¶ï¼Œ`count`çš„çŠ¶æ€ä¸º3ï¼Œåªæ˜¯æ­¤æ—¶å»¶è¿Ÿåˆ°3ç§’åæ‰§è¡Œã€‚

å¯ä»¥å‘ç°`count`åœ¨æ¯ä¸€æ¬¡å‡½æ•°è°ƒç”¨ä¸­éƒ½æ˜¯ä¸€ä¸ªå¸¸é‡å€¼ã€‚å€¼å¾—å¼ºè°ƒçš„æ˜¯ â€” **ç»„ä»¶å‡½æ•°æ¯æ¬¡æ¸²æŸ“éƒ½ä¼šè¢«è°ƒç”¨ï¼Œä½†æ˜¯æ¯ä¸€æ¬¡è°ƒç”¨ä¸­`count`å€¼éƒ½æ˜¯å¸¸é‡ï¼Œå¹¶ä¸”å®ƒè¢«èµ‹äºˆäº†å½“å‰æ¸²æŸ“ä¸­çš„çŠ¶æ€å€¼ã€‚**

è¿™ä¸æ˜¯Reactç‹¬æœ‰çš„ç‰¹æ€§ï¼Œæ™®é€šå‡½æ•°ä¹Ÿæœ‰ç±»ä¼¼è¡Œä¸ºã€‚

```jsx
function sayHi(person) {
  const name = person.name;  
  setTimeout(() => {
    alert('Hello, ' + name);
  }, 3000);
}

let someone = {name: 'Dan'};
sayHi(someone);

someone = {name: 'Yuzhi'};
sayHi(someone);

someone = {name: 'Dominic'};
sayHi(someone);
```

**åœ¨`sayHi`å‡½æ•°ä¸­ï¼Œå±€éƒ¨å¸¸é‡`name`ä¼šå’ŒæŸæ¬¡è°ƒç”¨ä¸­çš„`person`å…³è”ã€‚**å› ä¸ºè¿™ä¸ªå¸¸é‡æ˜¯å±€éƒ¨çš„ï¼Œæ‰€ä»¥æ¯ä¸€æ¬¡è°ƒç”¨éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚ç»“æœå°±æ˜¯ï¼Œå½“å®šæ—¶å™¨å›è°ƒè§¦å‘çš„æ—¶å€™ï¼Œæ¯ä¸€ä¸ªalertéƒ½ä¼šå¼¹å‡ºå®ƒæ‹¥æœ‰çš„`name`ã€‚

åŒæ ·çš„ï¼Œ`counter`çš„æ‰§è¡Œå¯ä»¥ç†è§£ä¸ºå¦‚ä¸‹è¿‡ç¨‹ï¼š

```jsx
// ç¬¬ä¸€æ¬¡ç‚¹å‡»
function Counter() {
  const count = 0; // Returned by useState()
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert('You clicked on: ' + count);
    }, 3000);
  }
  // ...
}

// ç¬¬äºŒæ¬¡ç‚¹å‡»
function Counter() {
  const count = 1; // Returned by useState()
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert('You clicked on: ' + count);
    }, 3000);
  }
  // ...
}

// ç¬¬ä¸‰æ¬¡ç‚¹å‡»
function Counter() {
  const count = 2; // Returned by useState()
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert('You clicked on: ' + count);
    }, 3000);
  }
  // ...
}
```

> çœ‹ç½¢ï¼Œä»”ç»†æƒ³æ¥ï¼Œä½¿ç”¨hooksçš„functionç»„ä»¶ä¸å°±æ˜¯ä¸€ä¸ªfunctionä¹ˆï¼Ÿâ€”â€”è¿™ä¸å°±æ˜¯functionçš„é—­åŒ…å˜›ï¼ç´¢å˜šæ–¯å†…~~

æ‰€ä»¥ï¼Œå®é™…ä¸Šæ¯ä¸€æ¬¡æ¸²æŸ“éƒ½æœ‰ä¸€ä¸ª**æ–°**çš„`handleAlertClick`ï¼Œè¿™ä¸ªæ–°çš„`handleAlertClick`è®°ä½äº†å®ƒè‡ªå·±çš„`count`ï¼š

```jsx
// ç¬¬ä¸€æ¬¡æ¸²æŸ“
function Counter() {
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert('You clicked on: ' + 0);
    }, 3000);
  }
  // ...
  <button onClick={handleAlertClick} /> // The one with 0 inside
  // ...
}

// ç‚¹å‡»æŒ‰é’®ï¼Œç¬¬äºŒæ¬¡æ¸²æŸ“
function Counter() {
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert('You clicked on: ' + 1);
    }, 3000);
  }
  // ...
  <button onClick={handleAlertClick} /> // The one with 1 inside
  // ...
}

// å†æ¬¡ç‚¹å‡»æŒ‰é’®ï¼Œç¬¬ä¸‰æ¬¡æ¸²æŸ“
function Counter() {
  // ...
  function handleAlertClick() {
    setTimeout(() => {
      alert('You clicked on: ' + 2);
    }, 3000);
  }
  // ...
  <button onClick={handleAlertClick} /> // The one with 2 inside
  // ...
}
```

è¿™ä¹Ÿè§£é‡Šäº†äº‹ä»¶å¤„ç†å‡½æ•°â€å±äºâ€œæŸä¸€æ¬¡ç‰¹å®šçš„æ¸²æŸ“ï¼Œåœ¨ä½ è°ƒç”¨å®ƒæ—¶ï¼Œå®ƒä¼šä½¿ç”¨è¯¥æ¬¡æ¸²æŸ“ä¸­çš„æ•°æ®ã€‚

**åœ¨ä»»æ„ä¸€æ¬¡æ¸²æŸ“ä¸­ï¼Œpropså’Œstateæ˜¯å§‹ç»ˆä¿æŒä¸å˜çš„ã€‚**å¦‚æœpropså’Œstateåœ¨ä¸åŒçš„æ¸²æŸ“ä¸­æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œé‚£ä¹ˆä½¿ç”¨åˆ°å®ƒä»¬çš„ä»»ä½•å€¼ä¹Ÿæ˜¯ç‹¬ç«‹çš„ï¼ˆåŒ…æ‹¬äº‹ä»¶å¤„ç†å‡½æ•°ï¼‰ã€‚å®ƒä»¬éƒ½â€œå±äºâ€ä¸€æ¬¡ç‰¹å®šçš„æ¸²æŸ“ã€‚

> **æ³¨**ï¼šä¸Šæ–‡æŒ‡å‡ºï¼Œæ¯ä¸€æ¬¡æ¸²æŸ“çš„propsä¸stateå‡æ˜¯ä¸å¯å˜çš„ï¼ˆä»–ä»¬è¢«constå£°æ˜ä¸ºå¸¸é‡ï¼‰ï¼Œè¿™æ ·ä½¿å¾—æˆ‘ä»¬åœ¨æ•´ä¸ªå®Œæ•´çš„æ¸²æŸ“è¿‡ç¨‹ä¸­è®¿é—®åˆ°çš„propsä¸stateä¿æŒä¸å˜ï¼ˆå®‰å…¨ï¼‰ã€‚åŒæ—¶è¿™ä¹Ÿæ„å‘³ç€åœ¨æˆ‘ä»¬**é€šè¿‡`setXxx`ä¿®æ”¹stateæ—¶ï¼Œä¸æ¨èç›´æ¥æ”¹å˜stateï¼Œè€Œæ˜¯åº”è¯¥é€šè¿‡ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼ˆ`setXxx(newObj)`ï¼‰ä¿®æ”¹state**ï¼Œå¦‚æ­¤ä¾¿èƒ½ä¿è¯æ•´ä¸ªï¼ˆä¸€æ¬¡ï¼‰æ¸²æŸ“ä¸­çš„stateä¸ä¼šè¢«æ±¡æŸ“ã€‚


---

é‚£æˆ‘ä»¬ä¸å¦¨å†æ¥çœ‹çœ‹çœ‹classç»„ä»¶ç‰ˆæœ¬ï¼š

```jsx
class Counter extends Component {
  constructor(...props: any[]) {
    super({...props})
    this.state = {
      count: 0
    }
  }

  handleAlertClick = () => {
    setTimeout(() => {
      alert('You clicked on: ' + this.state.count);
    }, 3000);
  }

  render() {
    return (
      <div>
        <p>You clicked {this.state.count} times</p>
        <button onClick={() => this.setState({ count: this.state.count + 1})}>
          Click me
        </button>
        <button onClick={this.handleAlertClick}>
          Show alert
        </button>
      </div>
    );
  }
}
```

classç»„ä»¶ç‰ˆæœ¬çš„ä¼šæ˜¾ç¤º3è¿˜æ˜¯5å‘¢ï¼Ÿå»è¯•è¯•å§ã€‚

â€”â€”ç­”æ¡ˆæ˜¯ 5ã€‚

ä¸ºä»€ä¹ˆç­”æ¡ˆæ˜¯5è€Œä¸æ˜¯3ï¼Œreactçš„è®¾è®¡ä¸å› è¯¥éµå¾ªç»Ÿä¸€çš„å°Šåˆ™ä¹ˆï¼Ÿæˆ‘ä¹Ÿæ˜¯è¿™ä¹ˆè§‰å¾—ã€‚ä½†å®ƒä»¬çš„ç¡®æ˜¯ä¸åŒçš„ã€‚**Reactä¿®æ”¹äº†classä¸­çš„`this.state`ä½¿å…¶æŒ‡å‘æœ€æ–°çŠ¶æ€ï¼Œå¯¼è‡´ä¸€ä¸ªåˆ‡ç‰‡ä¸Šçš„ï¼ˆæ¸²æŸ“ï¼‰æ•°æ®å¯å˜**ã€‚

ä¸Šè¿°é—®é¢˜å¯ä»¥ä½¿ç”¨é—­åŒ…æ¥ä¿®å¤ï¼Œä»¥æ­¤ä½¿å…¶å’Œ`hooks`ç‰ˆæœ¬è¡¨ç°ä¸€è‡´ã€‚å¦‚ä¸‹ï¼š

```jsx
// ...

handleAlertClick = () => {
  const count = this.state.count
  setTimeout(() => {
    alert('You clicked on: ' + count);
  }, 3000);
}

// ...
```

> æ‰€ä»¥åœ¨å€¼å§‹ç»ˆä¸å˜çš„æƒ…å†µä¸‹ä½¿ç”¨é—­åŒ…æ˜¯éå¸¸æ£’çš„ã€‚è¿™ä½¿å®ƒä»¬éå¸¸å®¹æ˜“æ€è€ƒï¼Œå› ä¸ºä½ æœ¬è´¨ä¸Šåœ¨å¼•ç”¨å¸¸é‡ã€‚

---

### Effects

ææ¸…æ¥šä¸Šé¢çš„é—®é¢˜ï¼Œç»ˆäºæ¥åˆ°æœ¬æ–‡ä¸»é¢˜ã€‚

å…¶å®åŒä¸Šæ–‡åˆ†æï¼Œ`useEffect`ä¹Ÿæ²¡ä»€ä¹ˆä¸¤æ ·ã€‚å› ä¸ºå®ƒä¹Ÿæ˜¯ä¸ªå‡½æ•°ã€‚

çœ‹å¦‚ä¸‹ä¾‹å­ï¼š

```jsx
function Counter() {
  const [count, setCount] = useState(0);
  useEffect(() => {
    document.title = `You clicked ${count} times`; // <--
  });
  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>
        Click me
      </button>
    </div>
  );
}
```

åœ¨è¿™é‡Œï¼Œeffectå¦‚ä½•å–åˆ°æœ€æ–°çš„`count`å€¼å‘¢ï¼Ÿ

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè‡ªä¿¡çš„ç­”å‡ºï¼š`count`æ˜¯ç‰¹å®šæ¸²æŸ“ä¸­çš„å¸¸é‡ï¼Œä¾æ‰˜é—­åŒ…ï¼Œeffectçš„handlerçœ‹åˆ°çš„æ€»æ˜¯é‚£ä¸ªç‰¹å®šçš„`count`ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œ**å¹¶ä¸æ˜¯`count`çš„å€¼åœ¨â€œä¸å˜â€çš„effectä¸­å‘ç”Ÿäº†æ”¹å˜ï¼Œè€Œæ˜¯*effect å‡½æ•°æœ¬èº«* åœ¨æ¯ä¸€æ¬¡æ¸²æŸ“ä¸­éƒ½ä¸ç›¸åŒã€‚**æ¯ä¸€ä¸ªç‰ˆæœ¬çš„effectçœ‹åˆ°çš„`count`å€¼å‡æ¥æºäºå®ƒå±äºçš„é‚£æ¬¡æ¸²æŸ“ã€‚

```jsx
// ç¬¬ä¸€æ¬¡æ¸²æŸ“
function Counter() {
  // ...
  useEffect(
    // Effect function from first render
    () => {
      document.title = `You clicked ${0} times`;
    }
  );
  // ...
}

// ç‚¹å‡»åï¼Œç¬¬äºŒæ¬¡
function Counter() {
  // ...
  useEffect(
    // Effect function from second render
    () => {
      document.title = `You clicked ${1} times`;
    }
  );
  // ...
}

// å†æ¬¡ç‚¹å‡»åï¼Œç¬¬ä¸‰æ¬¡
function Counter() {
  // ...
  useEffect(
    // Effect function from third render
    () => {
      document.title = `You clicked ${2} times`;
    }
  );
  // ..
}
```

Reactä¼šè®°ä½ä½ æä¾›çš„effectå‡½æ•°ï¼Œå¹¶ä¸”ä¼šåœ¨depsæ”¹å˜ä¸”æ›´æ”¹ä½œç”¨äºDOMå¹¶è®©æµè§ˆå™¨ç»˜åˆ¶å±å¹•åå»è°ƒç”¨å®ƒã€‚

æ‰€ä»¥è™½ç„¶æˆ‘ä»¬è¯´çš„æ˜¯ä¸€ä¸ª *effect*ï¼Œä½†å…¶å®æ¯æ¬¡æ¸²æŸ“éƒ½æ˜¯ä¸€ä¸ª*ä¸åŒçš„å‡½æ•°* â€” å¹¶ä¸”æ¯ä¸ªeffectå‡½æ•°â€œçœ‹åˆ°â€çš„propså’Œstateéƒ½æ¥è‡ªäºå®ƒå±äºçš„é‚£æ¬¡ç‰¹å®šæ¸²æŸ“ã€‚â€”â€”å®ƒä»¬çœ‹ä¼¼æ˜¯åŒä¸€ä¸ªï¼Œå®åˆ™ä¸æ˜¯ã€‚

> ä¸ºäº†ç¡®ä¿æˆ‘ä»¬å·²ç»æœ‰äº†æ‰å®çš„ç†è§£ï¼Œæˆ‘ä»¬å†å›é¡¾ä¸€ä¸‹ç¬¬ä¸€æ¬¡çš„æ¸²æŸ“è¿‡ç¨‹ï¼š
>
> - **React:** ç»™æˆ‘çŠ¶æ€ä¸º `0`æ—¶å€™çš„UIã€‚
> - **ä½ çš„ç»„ä»¶:**
>   - ç»™ä½ éœ€è¦æ¸²æŸ“çš„å†…å®¹: `<p>You clicked 0 times</p>`ã€‚
>   - è®°å¾—åœ¨æ¸²æŸ“å®Œäº†ä¹‹åè°ƒç”¨è¿™ä¸ªeffect: `() => { document.title = 'You clicked 0 times' }`ã€‚
> - **React:** æ²¡é—®é¢˜ã€‚å¼€å§‹æ›´æ–°UIï¼Œå–‚æµè§ˆå™¨ï¼Œæˆ‘è¦ç»™DOMæ·»åŠ ä¸€äº›ä¸œè¥¿ã€‚
> - **æµè§ˆå™¨:** é…·ï¼Œæˆ‘å·²ç»æŠŠå®ƒç»˜åˆ¶åˆ°å±å¹•ä¸Šäº†ã€‚
> - **React:** å¥½çš„ï¼Œ æˆ‘ç°åœ¨å¼€å§‹è¿è¡Œç»™æˆ‘çš„effect
>   - è¿è¡Œ `() => { document.title = 'You clicked 0 times' }`ã€‚
>
> ------
>
> ç°åœ¨æˆ‘ä»¬å›é¡¾ä¸€ä¸‹æˆ‘ä»¬ç‚¹å‡»ä¹‹åå‘ç”Ÿäº†ä»€ä¹ˆï¼š
>
> - **ä½ çš„ç»„ä»¶:** å–‚ React, æŠŠæˆ‘çš„çŠ¶æ€è®¾ç½®ä¸º`1`ã€‚
> - **React:** ç»™æˆ‘çŠ¶æ€ä¸º `1`æ—¶å€™çš„UIã€‚
> - **ä½ çš„ç»„ä»¶:**
>   - ç»™ä½ éœ€è¦æ¸²æŸ“çš„å†…å®¹: `<p>You clicked 1 times</p>`ã€‚
>   - è®°å¾—åœ¨æ¸²æŸ“å®Œäº†ä¹‹åè°ƒç”¨è¿™ä¸ªeffectï¼š `() => { document.title = 'You clicked 1 times' }`ã€‚
> - **React:** æ²¡é—®é¢˜ã€‚å¼€å§‹æ›´æ–°UIï¼Œå–‚æµè§ˆå™¨ï¼Œæˆ‘ä¿®æ”¹äº†DOMã€‚
> - **Browser:** é…·ï¼Œæˆ‘å·²ç»å°†æ›´æ”¹ç»˜åˆ¶åˆ°å±å¹•ä¸Šäº†ã€‚
> - **React:** å¥½çš„ï¼Œ æˆ‘ç°åœ¨å¼€å§‹è¿è¡Œå±äºè¿™æ¬¡æ¸²æŸ“çš„effect
>   - è¿è¡Œ `() => { document.title = 'You clicked 1 times' }`ã€‚

---

## å°è¯•å›ç­”æˆ‘ä»¬çš„é—®é¢˜

çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†â€œæ¸²æŸ“â€çš„ä¸€äº›ç†å¿µï¼Œå¯ä»¥å°è¯•ç€è§£ç­”å¼€å¤´æå‡ºçš„é—®é¢˜ã€‚

ä½ å¯èƒ½å·²ç»å¿˜äº†é—®é¢˜æå‡ºçš„é—®é¢˜æ˜¯å•¥ï¼Œè¯´æ˜ä½ å·²ç»åœ¨ä¸Šé¢çš„å­¦ä¹ ä¸­èä¼šè´¯é€šï¼Œè¿™å¾ˆæ£’ã€‚

å¦‚æœä½ å•çº¯å’Œæˆ‘ä¸€æ ·è®°æ€§ä¸å¥½ğŸ˜‚ï¼Œå¯ä»¥åˆ°[å‰è¨€](#å‰è¨€)å¿«é€Ÿå›é¡¾ã€‚

### **ğŸ¤”**å¦‚ä½•ä½¿ç”¨`useEffect`æ¨¡æ‹Ÿ`componentDidMount`ç”Ÿå‘½å‘¨æœŸï¼Ÿ

ä½ å¯èƒ½å·²ç»åœ¨å¾ˆå¤šå…¶ä»–çš„åšå®¢äº†è§£åˆ°å¯ä»¥ä½¿ç”¨`useEffect(fn, [])`ï¼Œä½†æ˜¯å®ƒä»¬å´å¹¶ä¸å®Œå…¨ç›¸ç­‰ã€‚

> hookså’Œç”Ÿå‘½å‘¨æœŸåŸºäºä¸åŒçš„åŸåˆ™ã€‚`compomentDidMount`ä¹‹ç±»çš„æ–¹æ³•æ˜¯å›´ç»•å£°æ˜å‘¨æœŸå’Œæ¸²æŸ“æ—¶é—´å±•å¼€ï¼Œè€Œhooksåˆ™æ˜¯å›´ç»•stateå’Œä¸DOMçš„åŒæ­¥è®¾è®¡çš„ã€‚

å’Œ`componentDidMount`ä¸ä¸€æ ·ï¼Œ`useEffect`ä¼š*æ•è·* propså’Œstateã€‚æ‰€ä»¥å³ä¾¿åœ¨å›è°ƒå‡½æ•°é‡Œï¼Œä½ æ‹¿åˆ°çš„è¿˜æ˜¯åˆå§‹çš„propså’Œstateã€‚å¦‚æœä½ æƒ³å¾—åˆ°â€œæœ€æ–°â€çš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨refã€‚

> è®°ä½ï¼Œeffectsçš„å¿ƒæ™ºæ¨¡å‹å’Œ`componentDidMount`ä»¥åŠå…¶ä»–ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸åŒçš„ï¼Œè¯•å›¾æ‰¾åˆ°å®ƒä»¬ä¹‹é—´å®Œå…¨ä¸€è‡´çš„è¡¨è¾¾åè€Œæ›´å®¹æ˜“ä½¿ä½ æ··æ·†ã€‚æƒ³è¦æ›´æœ‰æ•ˆï¼Œä½ éœ€è¦â€œthink in effectsâ€ï¼Œ**å®ƒçš„å¿ƒæ™ºæ¨¡å‹æ›´æ¥è¿‘äºå®ç°çŠ¶æ€åŒæ­¥**ï¼Œè€Œä¸æ˜¯å“åº”ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚

### **ğŸ¤”**å¦‚ä½•ä¼˜é›…åœ°åœ¨`useEffect`å†…è¯·æ±‚æ•°æ®å‘¢ï¼Ÿ

æˆ‘ä»¬çŸ¥é“`useEffect`ä¸èƒ½æ¥å—å¼‚æ­¥æ–¹æ³•ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ç›´æ¥åœ¨`useEffect`å†…ä½¿ç”¨`async/await`è¯­æ³•æ˜¯ä¸å¯è¡Œçš„ã€‚

```jsx
useEffect(async () => {
  const res = await getData() // è¿™æ˜¯ä¸è¢«å…è®¸çš„
}, [])
```

ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å°†å¼‚æ­¥è¯·æ±‚çš„é€»è¾‘æŠ½ç¦»å‡ºæ¥ï¼Œå®šä¹‰ä¸ºä¸€ä¸ª`async`æ–¹æ³•ã€‚

```jsx
useEffect(() => {
  async function getInitData() {
      const res = await getData()
  }
  getInitData()	// è¿™æ˜¯è¢«å…è®¸çš„
}, [])
```

> `[]`è¡¨ç¤ºeffectæ²¡æœ‰ä½¿ç”¨ä»»ä½•Reactæ•°æ®æµé‡Œçš„å€¼ï¼Œå› æ­¤è¯¥effectä»…è¢«è°ƒç”¨ä¸€æ¬¡æ˜¯å®‰å…¨çš„ã€‚`[]`åŒæ ·ä¹Ÿæ˜¯ä¸€ç±»å¸¸è§é—®é¢˜çš„æ¥æºï¼Œä¹Ÿå³ä½ ä»¥ä¸ºæ²¡ä½¿ç”¨æ•°æ®æµé‡Œçš„å€¼ä½†å…¶å®ä½¿ç”¨äº†ã€‚ä½ éœ€è¦å­¦ä¹ ä¸€äº›ç­–ç•¥ï¼ˆä¸»è¦æ˜¯`useReducer` å’Œ `useCallback`ï¼‰æ¥ç§»é™¤è¿™äº›effectä¾èµ–ï¼Œè€Œä¸æ˜¯é”™è¯¯åœ°å¿½ç•¥å®ƒä»¬ã€‚



### **ğŸ¤”**ä¸ºä»€ä¹ˆæœ‰æ—¶å€™ä¼šå‡ºç°æ— é™è¯·æ±‚çš„æƒ…å†µï¼Ÿ

è¿™ä¸ªé€šå¸¸å‘ç”Ÿäºä¸‹åˆ—æƒ…å†µï¼š

* ä½ åœ¨effecté‡Œåšæ•°æ®è¯·æ±‚å¹¶ä¸”æ²¡æœ‰è®¾ç½®effectä¾èµ–å‚æ•°ã€‚

  ```jsx
  useEffect(() => {
    async function getInitData() {
        const res = await getData()
    }
    getInitData()
  })
  ```

* åœ¨useEffectå†…è¯·æ±‚æ•°æ®å¹¶ä»¥æ­¤æ”¹å˜stateï¼ŒåŒæ—¶å°†stateç½®äºuseEffectçš„ä¾èµ–å‚æ•°depså†…ã€‚

  ```jsx
  const [state, setState] = useState({})
  useEffect(() => {
    async function getInitData() {
      const res = await getData()
      if(res) {
        setState(res)
      }
    }
    getInitData()
  }, [state])
  ```

åœ¨æ²¡æœ‰è®¾ç½®è®¾ç½®`useEffect`ä¾èµ–çš„æƒ…å†µä¸‹ï¼Œeffectåœ¨æ¯æ¬¡é€‰ç„¶åæ‰§è¡Œä¸€æ¬¡ï¼Œç„¶åå†effectä¸­æ›´æ–°äº†çŠ¶æ€å¼•èµ·æ¸²æŸ“å¹¶å†æ¬¡è§¦å‘effectï¼Œå¦‚æ­¤åå¤ï¼Œé€ æˆæ— é™è¯·æ±‚çš„æƒ…å†µã€‚

åŒç†ï¼Œæ— é™å¾ªç¯çš„å‘ç”Ÿä¹Ÿå¯èƒ½æ˜¯å› ä¸ºä½ è®¾ç½®çš„ä¾èµ–æ€»æ˜¯ä¼šæ”¹å˜ã€‚ä½ å¯ä»¥é€šè¿‡ä¸€ä¸ªä¸€ä¸ªç§»é™¤çš„æ–¹å¼æ’æŸ¥åˆ°åº•æ˜¯å“ªä¸ªä¾èµ–å‡ºç°äº†é—®é¢˜ã€‚ï¼ˆå‡½æ•°å¯èƒ½ä¼šå¯¼è‡´è¿™ä¸ªé—®é¢˜ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥å°†å‡½æ•°æåˆ°`useEffect`å†…éƒ¨ï¼Œæˆ–è€…ç»„ä»¶å¤–é¢ï¼Œæˆ–è¿™ç”¨`useCallback`åŒ…è£¹ï¼‰

### **ğŸ¤”**æˆ‘æœ‰å¿…è¦æŠŠæ‰€æœ‰åœ¨effecté‡Œç”¨åˆ°çš„æ•°æ®åŠ åˆ°ä¾èµ–ä¹ˆï¼Ÿ

æ¨èå°†ä½ ä½¿ç”¨çš„ä¾èµ–æ·»åŠ åˆ°effectçš„ä¾èµ–æ•°ç»„é‡Œã€‚

**`useEffect`é€šè¿‡ä¾èµ–æ•°ç»„depsæ¥å¯¹æ¯”ä½ çš„effectsä»¥å†³å®šæ‰§ä¸æ‰§è¡Œã€‚å¦‚æœå½“å‰æ¸²æŸ“ä¸­çš„è¿™äº›ä¾èµ–é¡¹å’Œä¸Šä¸€æ¬¡è¿è¡Œè¿™ä¸ªeffectçš„æ—¶å€™å€¼ä¸€æ ·ï¼ŒReactå°†ä¼šè‡ªåŠ¨è·³è¿‡è¿™æ¬¡effectï¼ˆå› ä¸ºæ²¡æœ‰ä»€ä¹ˆéœ€è¦åŒæ­¥ï¼‰ã€‚**

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ å¦‚æœæƒ³è¦é¿å…effectsä¸å¿…è¦çš„é‡å¤è°ƒç”¨ï¼Œä½ åªéœ€è¦æä¾›ç»™`useEffect`ä¸€ä¸ªä¾èµ–æ•°ç»„å‚æ•°(deps)çš„åŸå› ã€‚

```jsx
const [name, setName] = useState('')
useEffect(() => {
  console.log(name)
}, [name])
```

åªæœ‰å½“nameçš„å€¼æ”¹å˜æ—¶ï¼Œeffectæ‰ä¼šå†æ¬¡æ‰§è¡Œã€‚**è¿™å¥½æ¯”ä½ å‘Šè¯‰Reactï¼šâ€œHeyï¼Œæˆ‘çŸ¥é“ä½ çœ‹ä¸åˆ°è¿™ä¸ªå‡½æ•°é‡Œçš„ä¸œè¥¿ï¼Œä½†æˆ‘å¯ä»¥ä¿è¯åªä½¿ç”¨äº†æ¸²æŸ“ä¸­çš„`name`ï¼Œåˆ«æ— å…¶ä»–ã€‚nameæ”¹å˜äº†ï¼Œä½ å°±æŠŠè¿™ä¸ªeffectå†æ‰§è¡Œä¸€æ¬¡ã€‚â€**

#### å…³äºä¾èµ–é¡¹ï¼Œä¸è¦å¯¹Reactè¯´è°

> å…³äºä¾èµ–é¡¹å¯¹Reactæ’’è°ä¼šæœ‰ä¸å¥½çš„ç»“æœã€‚ç›´è§‰ä¸Šï¼Œè¿™å¾ˆå¥½ç†è§£ï¼Œä½†æˆ‘æ›¾çœ‹åˆ°å‡ ä¹æ‰€æœ‰ä¾èµ–classå¿ƒæ™ºæ¨¡å‹ä½¿ç”¨`useEffect`çš„äººéƒ½è¯•å›¾è¿åè¿™ä¸ªè§„åˆ™ã€‚ï¼ˆæˆ‘åˆšå¼€å§‹ä¹Ÿè¿™ä¹ˆå¹²äº†ï¼ï¼‰

Danå¦‚æ˜¯è¯´ï¼ŒçœŸå·§ï¼Œæˆ‘ä¹Ÿæ˜¯:smile:ã€‚

è‡³äºä¸ºä»€ä¹ˆï¼Œæˆ‘ä¹Ÿä¸å¥½è¯´ï¼Œ[Reactå®˜æ–¹FAQ](https://zh-hans.reactjs.org/docs/hooks-faq.html#is-it-safe-to-omit-functions-from-the-list-of-dependencies)æœ‰æåˆ°ï¼Œå¯ä»¥å»çœ‹çœ‹ã€‚

#### è¯šå®å‘ŠçŸ¥ä¾èµ–çš„æ–¹æ³•

* **åœ¨ä¾èµ–ä¸­åŒ…å«æ‰€æœ‰åœ¨effectä¸­ç”¨åˆ°çš„ç»„ä»¶ä¸­çš„å€¼**ã€‚

* **ä¿®æ”¹effectå†…éƒ¨çš„ä»£ç ä»¥ç¡®ä¿å®ƒåŒ…å«çš„å€¼åªä¼šåœ¨éœ€è¦çš„æ—¶å€™å‘ç”Ÿå˜æ›´**

  è¿™ä¸ªä¸å¿…å¤šè¯´ï¼Œæ‡‚çš„éƒ½æ‡‚ã€‚:satisfied:

---

æœ‰æ—¶å€™ï¼Œä¸ºäº†æ›´æ–°ä¸€ä¸ªçŠ¶æ€ï¼Œä½ ä¸å¾—ä¸åœ¨effectä½¿ç”¨åŸçŠ¶æ€ï¼Œå¦‚ä¸‹ï¼š

```jsx
// ...
const [count, setCount] = useState(0)

useEffect(() => {
  const timer = setTimeout(() => {
    setCount(count + 1)
  }, 1000) // 1s å count + 1
}, [count])

// ...
```

å¦‚æ­¤ï¼Œä¸ºäº†é¿å…eslintçš„è­¦å‘Šï¼Œä½ ä¸å¾—ä¸å°†`count`åŠ å…¥effectä¾èµ–ã€‚

æˆ‘ä»¬èƒ½åšä¸€äº›æ”¹è¿›ä¹ˆï¼Ÿ

> å½“æˆ‘ä»¬éœ€è¦æ ¹æ®å‰ä¸€ä¸ªçŠ¶æ€æ¥æ›´æ–°çŠ¶æ€æ—¶ï¼Œå¯ä»¥ä½¿ç”¨`setXxx`çš„å‡½æ•°å½¢å¼æ¥æ›´æ–°çŠ¶æ€ã€‚

å¯ä»¥çœ‹åˆ°åªåœ¨`setCount`ä¸­ä½¿ç”¨äº†`count`ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…¶å®å¹¶ä¸éœ€è¦åœ¨effectä¸­ä½¿ç”¨`count`ã€‚

```jsx
// ...
const [count, setCount] = useState(0)

useEffect(() => {
  const timer = setTimeout(() => {
    setCount(c => c + 1)
  }, 1000) // 1s å count + 1
}, [])

// ...
```

---

ä½†å¾ˆå¿«ä½ ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå½“æˆ‘éœ€è¦æ›´æ–°çš„çŠ¶æ€ä¾èµ–é™¤äº†åŒ…æ‹¬å‰ä¸€çŠ¶æ€è¿˜åŒ…æ‹¬å…¶ä»–çŠ¶æ€çš„æ—¶å€™ï¼ˆæ¯”å¦‚ä¾èµ–propsï¼‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¸å¾—ä¸åœ¨effectä¾èµ–ä¸­å¼•å…¥å…¶ä»–çš„ä¾èµ–ï¼ˆå¦‚propsç­‰ï¼‰ã€‚å¦‚ä¸‹ï¼š

```jsx
const step = props.step // stepæ¥è‡ªprops
const [count, setCount] = useState(0)

useEffect(() => {
  const timer = setInterval(() => {
    setCount(c => c + step)
  }, 1000) // æ¯1s count + step
  return () => clearInterval(timer)
}, [step])
```

ç°åœ¨ï¼Œä¸€æ—¦`step`å€¼å‘ç”Ÿå˜åŒ–ï¼Œå®šæ—¶å™¨å°†ä¼šè¢«é‡å¯ï¼Œå› ä¸ºå®ƒä¾èµ–äº†`step`ã€‚è¿™æ˜¯æˆ‘ä»¬æ‰€ä¸å¸Œæœ›çœ‹åˆ°çš„ã€‚

å¹¸è¿çš„æ˜¯ï¼Œ`setXxx(pre => {})`å§å¦¹æ¨¡å¼ï¼Œä¸”æ›´åŠ å¼ºå¤§ï¼Œèƒ½å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å®ƒå°±æ˜¯`useReducer`.

åœ¨ hooks ä¸­æä¾›äº†çš„ useReducer åŠŸèƒ½ï¼Œå¯ä»¥å¢å¼º ReducerDemo å‡½æ•°æä¾›ç±»ä¼¼ Redux çš„åŠŸèƒ½ã€‚å®ƒæ¥æ”¶ä¸€ä¸ª`reducer`å‡½æ•°å’Œä¸€ä¸ªåˆå§‹çŠ¶æ€å€¼ä½œä¸ºå‚æ•°ï¼Œè¿”å›`state`ä¸`dispatch`ã€‚æ›´å¤šæœ‰å…³[`useReducer`]()çš„ä¿¡æ¯ä½ å¯ä»¥å»è¿™é‡Œã€‚

é‚£ä¹ˆä¸Šé¢çš„ä¾‹å­å¯ä»¥ä½¿ç”¨`useReducer`æ”¹å†™æˆä¸ºä¸‹é¢çš„æ ·å­ï¼š

```jsx
const step = props.step // stepæ¥è‡ªprops
const reducer = useCallback((state, action) => {
  switch(action) {
    case 'add':
      return state + step
    case 'dec':
      return state - step
    default:
      return state
  }
}, [step])
const [count, dispatch] = useReducer(reducer, 0)

useEffect(() => {
  const timer = setInterval(() => {
    dispatch('add')
  }, 1000) // 1sé—´éš” count + step
  return () => clearInterval(timer)
}, [dispatch])
```

> **Reactä¼šä¿è¯`dispatch`åœ¨ç»„ä»¶çš„å£°æ˜å‘¨æœŸå†…ä¿æŒä¸å˜ã€‚**

æ‰€ä»¥ä¸Šé¢ä¾‹å­ä¸­ä¸å†éœ€è¦é‡æ–°è®¢é˜…å®šæ—¶å™¨ã€‚é—®é¢˜è§£å†³

<u>*ï¼ˆä½ å¯ä»¥ä»ä¾èµ–ä¸­å»é™¤`dispatch`, `setState`, å’Œ`useRef`åŒ…è£¹çš„å€¼å› ä¸ºReactä¼šç¡®ä¿å®ƒä»¬æ˜¯é™æ€çš„ã€‚ä¸è¿‡ä½ è®¾ç½®äº†å®ƒä»¬ä½œä¸ºä¾èµ–ä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ã€‚ï¼‰*</u>

---

### **ğŸ¤”**æˆ‘åº”è¯¥æŠŠå‡½æ•°å½“ä½œ`useEffect`ä¾èµ–ä¹ˆï¼Ÿ

ä¸€ä¸ªå…¸å‹çš„è¯¯è§£æ˜¯è®¤ä¸ºå‡½æ•°ä¸åº”è¯¥æˆä¸ºä¾èµ–ï¼Œä½†åœ¨ä¿è¯ç¨‹åºè¿è¡Œæ­£ç¡®çš„æƒ…å†µä¸‹åº”è¯¥å‡å°‘ç›´æ¥å°†å‡½æ•°ä½œä¸ºä¾èµ–ã€‚

```jsx
// ...

const getData = async () => {
  // è·å–æ•°æ®
}

useEffect(() => {
  getData()
}, [])

// ...
```

è¿™æ ·çš„ä»£ç å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä½†ä½ å¾ˆéš¾ä¿è¯å®ƒåœ¨ä»Šåçš„æ—¥æ¸å¤æ‚çš„è¿­ä»£åè¿˜èƒ½æ­£å¸¸å·¥ä½œã€‚å‰æ–‡çš„ç»éªŒå‘Šè¯‰æˆ‘ä»¬effectä¾èµ–äº†`getData`ï¼Œæˆ‘ä»¬åº”è¯¥å°†å…¶æ·»åŠ åˆ°effectä¾èµ–é‡Œã€‚

```jsx
// ...

const getData = async () => {
  // è·å–æ•°æ®
}

useEffect(() => {
  getData()
}, [getData])

// ...
```

å¥½äº†ï¼Œä»£ç æ”¹å¥½äº†ï¼Œé‚£è¿™æ ·æ˜¯ä¸æ˜¯å°±è¡Œäº†å‘¢ï¼Ÿå¦‚æœä½ çš„ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œé‚£ä½ è¿˜å¾—ç¿»é˜…å‰æ–‡ï¼Œä»”ç»†æƒ³æƒ³ã€‚

å‰æ–‡çš„ç»éªŒå‘Šè¯‰æˆ‘ä»¬ï¼Œreactçš„æ¯ä¸€æ¬¡æ¸²æŸ“éƒ½æ˜¯functionçš„å†æ‰§è¡Œã€‚é‚£ä¹ˆçœ‹ä¼¼ä¸å˜çš„`getData`å…¶å®ä¸€ç›´åœ¨å˜ï¼Œå®ƒä»¬åœ¨å‡½æ•°functionæ‰§è¡Œæ—¶è¢«åˆ›å»ºï¼Œåœ¨æ‰§è¡Œå®Œåé”€æ¯ã€‚å®ƒä»¬ä¸æ˜¯åŒä¸€ä¸ªå‡½æ•°ï¼Œè¿™æ ·å°†å¯¼è‡´effectçš„ä¾èµ–åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶è¢«æ›´æ–°ï¼Œå¦‚æœä½ åœ¨è¯·æ±‚æ•°æ®æ—¶æ”¹å˜äº†stateï¼Œeffectå°†ä¼šè¢«ä¸åœæ‰§è¡Œã€‚æ˜¾ç„¶ï¼Œè¿™æ˜¯ä¸å¯è¡Œçš„ã€‚

å¯è¡Œçš„è§£å†³æ–¹æ¡ˆæœ‰ä¸€ä¸‹ä¸‰ä¸ªï¼š

* å°†ä»…æœ‰æŸä¸ªeffectä½¿ç”¨çš„å‡½æ•°ç§»å…¥è¯¥effectå†…

  ```jsx
  // ...
  useEffect(() => {
    const getData = async () => {
      // è·å–æ•°æ®
  	}
    getData()
  }, [getData])
  // ...
  ```

* å°†éœ€è¦é€»è¾‘å¤ç”¨çš„å‡½æ•°ç”¨useCallbackåŒ…è£¹

  `useCallback`æœ¬è´¨ä¸Šæ˜¯æ·»åŠ äº†ä¸€å±‚ä¾èµ–æ£€æŸ¥ã€‚å®ƒä»¥å¦ä¸€ç§æ–¹å¼è§£å†³äº†é—®é¢˜ - **æˆ‘ä»¬ä½¿å‡½æ•°æœ¬èº«åªåœ¨éœ€è¦çš„æ—¶å€™æ‰æ”¹å˜ï¼Œè€Œä¸æ˜¯å»æ‰å¯¹å‡½æ•°çš„ä¾èµ–ã€‚**

  ```js
  const getData = useCallback(async () => {
    // è·å–æ•°æ®
  }, [])
  
  useEffect(() => {
    getData()
  }, [getData])
  ```

* å°†æœªä½¿ç”¨functionç»„ä»¶å†…çš„æ•°æ®çš„å‡½æ•°ç§»åˆ°functionå¤–

  ```jsx
  const getData = async () => {
  	// è·å–æ•°æ®
  }

  const Demo = () => {
    useEffect(() => {
      getData()
    }, [])
    return (
      <div>{/* code here */}</div>
    )
  }
  ```

> `eslint-plugin-react-hooks` æ’ä»¶çš„`exhaustive-deps`lintè§„åˆ™ä¼šåœ¨ä½ [ç¼–ç çš„æ—¶å€™å°±åˆ†æeffects](https://github.com/facebook/react/issues/14920)å¹¶ä¸”æä¾›å¯èƒ½é—æ¼ä¾èµ–çš„å»ºè®®ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœºå™¨ä¼šå‘Šè¯‰ä½ ç»„ä»¶ä¸­å“ªäº›æ•°æ®æµå˜æ›´æ²¡æœ‰è¢«æ­£ç¡®åœ°å¤„ç†ï¼Œååˆ†å»ºè®®ä½ åœ¨å¼€å‘æ—¶å¼€å¯ã€‚

### **ğŸ¤”**ä¸ºä»€ä¹ˆæœ‰æ—¶å€™åœ¨`useEffect`é‡Œæ‹¿åˆ°äº†æ—§çš„æ•°æ®ï¼Ÿ(æ˜æˆ‘åˆšåˆš`setXxx`)

åœ¨effectä¾èµ–æ— è¯¯çš„æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°è¿™ç§æƒ…å†µï¼š

```jsx
// ...
const [count, setCount] = useState(0)

useEffect(() => {
  setCount(10)
  console.log(count) // é¦–æ¬¡è¾“å‡º 0
}, [count])

// ...
```

æˆ‘æ˜æ˜åˆšåˆš`setCount`ï¼Œä¸ºä»€ä¹ˆ`console.log`çš„å€¼å´è¿˜æ˜¯ä¹‹å‰çš„å€¼ï¼Ÿï¼ˆè¿™é‡Œä¸ä¼šè§¦å‘æ— é™é‡æ¸²æŸ“ï¼Œå› ä¸ºstateå€¼æ”¹å˜ä¸º10åä¾¿ä¸å†æ”¹å˜ï¼‰

è¿™æ˜¯å› ä¸º**Effectæ‹¿åˆ°çš„æ€»æ˜¯å®šä¹‰å®ƒçš„é‚£æ¬¡æ¸²æŸ“ä¸­çš„propså’Œstate**ã€‚

ä½ åœ¨è¿™æ¬¡æ¸²æŸ“ä¸­æ”¹å˜çš„stateï¼Œåœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“ä¸­æ‰ä¼šè¢«effectæ‹¿åˆ°ã€‚

å¦‚æœè¿™æ˜¯ä½ ä¸å¸Œæœ›çœ‹åˆ°çš„ï¼Œä½ å¯ä»¥ä½¿ç”¨refæ¥ä¿å­˜è¿™äº›å€¼ï¼Œæ¥ä¿è¯å®ƒä»¬çš„å€¼æ€»æ˜¯æœ€æ–°ã€‚

å¦‚æœä»¥ä¸Šé—®é¢˜ä½ éƒ½æ²¡æœ‰ï¼Œä½†è¿˜æ˜¯æ‹¿åˆ°æ—§çš„å€¼ï¼Œé‚£ä½ å¾ˆå¯èƒ½é—æ¼äº†ä¸€äº›ä¾èµ–ã€‚

### **ğŸ¤”**`useEffect`å’Œ`useLayuoutEffect`çš„ç›¸æ¯”æµè§ˆå™¨æ¸²æŸ“çš„ç¡®åˆ‡æ‰§è¡Œæ—¶æœºåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ

å‡†ç¡®æ¥è¯´ï¼Œè¿™ä¸ªé—®é¢˜å…¶å®å¹¶ä¸åœ¨æœ¬æ–‡çš„è®¨è®ºèŒƒå›´ï¼Œä½†è¿˜æ˜¯ç®€å•å›ç­”ä¸‹è¿™ä¸ªé—®é¢˜ã€‚

å…¶å®å®˜æ–¹æ–‡æ¡£å·²ç»å¯¹è¿™ä¸ªé—®é¢˜æœ‰è¿‡è¯¦ç»†çš„è§£é‡Šï¼Œåœ¨è¿™é‡Œæˆ‘å°±æ´å¼•å®˜æ–¹æ–‡æ¡£ï¼š

> ä¸ `componentDidMount`ã€`componentDidUpdate` ä¸åŒçš„æ˜¯ï¼Œåœ¨æµè§ˆå™¨å®Œæˆå¸ƒå±€ä¸ç»˜åˆ¶**ä¹‹å**ï¼Œä¼ ç»™ `useEffect` çš„å‡½æ•°ä¼šå»¶è¿Ÿè°ƒç”¨ã€‚è¿™ä½¿å¾—å®ƒé€‚ç”¨äºè®¸å¤šå¸¸è§çš„å‰¯ä½œç”¨åœºæ™¯ï¼Œæ¯”å¦‚è®¾ç½®è®¢é˜…å’Œäº‹ä»¶å¤„ç†ç­‰æƒ…å†µï¼Œå› æ­¤ä¸åº”åœ¨å‡½æ•°ä¸­æ‰§è¡Œé˜»å¡æµè§ˆå™¨æ›´æ–°å±å¹•çš„æ“ä½œã€‚
>
> ç„¶è€Œï¼Œå¹¶éæ‰€æœ‰ effect éƒ½å¯ä»¥è¢«å»¶è¿Ÿæ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œåœ¨æµè§ˆå™¨æ‰§è¡Œä¸‹ä¸€æ¬¡ç»˜åˆ¶å‰ï¼Œç”¨æˆ·å¯è§çš„ DOM å˜æ›´å°±å¿…é¡»åŒæ­¥æ‰§è¡Œï¼Œè¿™æ ·ç”¨æˆ·æ‰ä¸ä¼šæ„Ÿè§‰åˆ°è§†è§‰ä¸Šçš„ä¸ä¸€è‡´ã€‚ï¼ˆæ¦‚å¿µä¸Šç±»ä¼¼äºè¢«åŠ¨ç›‘å¬äº‹ä»¶å’Œä¸»åŠ¨ç›‘å¬äº‹ä»¶çš„åŒºåˆ«ã€‚ï¼‰React ä¸ºæ­¤æä¾›äº†ä¸€ä¸ªé¢å¤–çš„ useLayoutEffect Hook æ¥å¤„ç†è¿™ç±» effectã€‚å®ƒå’Œ `useEffect` çš„ç»“æ„ç›¸åŒï¼ŒåŒºåˆ«åªæ˜¯è°ƒç”¨æ—¶æœºä¸åŒã€‚
>
> <u>**è™½ç„¶ `useEffect` ä¼šåœ¨æµè§ˆå™¨ç»˜åˆ¶åå»¶è¿Ÿæ‰§è¡Œï¼Œä½†ä¼šä¿è¯åœ¨ä»»ä½•æ–°çš„æ¸²æŸ“å‰æ‰§è¡Œã€‚React å°†åœ¨ç»„ä»¶æ›´æ–°å‰åˆ·æ–°ä¸Šä¸€è½®æ¸²æŸ“çš„ effect**</u>ã€‚

æˆ‘ä»¬å¯ä»¥ä»ä¸­æç‚¼å‡ºä¸€äº›ä¿¡æ¯ï¼š

* èµ‹å€¼ç»™`useEffect`çš„å‡½æ•°ä¼šåœ¨ç»„ä»¶**æ¸²æŸ“åˆ°å±å¹•ä¹‹åã€ä¸‹ä¸€æ¬¡æ¸²æŸ“ä¹‹å‰**æ‰§è¡Œï¼Œreactå°†åœ¨ç»„ä»¶æ›´æ–°å‰åˆ·æ–°ä¸Šä¸€è½®çš„effectã€‚
* `useLayoutEffect`ä¼šåœ¨æ‰€æœ‰çš„DOMå˜æ›´ä¹‹ååŒæ­¥è°ƒç”¨effectã€‚å¯ä»¥ç”¨å®ƒæ¥è¯»å–DOMå¹¶åŒæ­¥è§¦å‘é‡æ¸²æŸ“ã€‚åœ¨æµè§ˆå™¨ç»˜åˆ¶ä¹‹å‰ï¼Œ`useLayoutEffect`å†…éƒ¨çš„æ›´æ–°è®¡åˆ’å°†è¢«åŒæ­¥åˆ·æ–°ã€‚

### **ğŸ¤”**effectåœ¨ä»€ä¹ˆæ—¶é—´ç‚¹æ¸…ç†ï¼Ÿ

Reactå®˜æ–¹æ–‡æ¡£ä¸­æœ‰è§£é‡Šï¼š

> é€šå¸¸ï¼Œç»„ä»¶å¸è½½æ—¶éœ€è¦æ¸…é™¤ effect åˆ›å»ºçš„è¯¸å¦‚è®¢é˜…æˆ–è®¡æ—¶å™¨ ID ç­‰èµ„æºã€‚è¦å®ç°è¿™ä¸€ç‚¹ï¼Œ`useEffect` å‡½æ•°éœ€è¿”å›ä¸€ä¸ªæ¸…é™¤å‡½æ•°ã€‚
>
> ```jsx
> useEffect(() => {
>   const subscription = props.source.subscribe();
>   return () => {
>     // æ¸…é™¤è®¢é˜…
>     subscription.unsubscribe();
>   };
> });
> ```
>
> ä¸ºé˜²æ­¢å†…å­˜æ³„æ¼ï¼Œæ¸…é™¤å‡½æ•°ä¼šåœ¨ç»„ä»¶å¸è½½å‰æ‰§è¡Œã€‚å¦å¤–ï¼Œå¦‚æœç»„ä»¶å¤šæ¬¡æ¸²æŸ“ï¼ˆé€šå¸¸å¦‚æ­¤ï¼‰ï¼Œåˆ™**åœ¨æ‰§è¡Œä¸‹ä¸€ä¸ª effect ä¹‹å‰ï¼Œä¸Šä¸€ä¸ª effect å°±å·²è¢«æ¸…é™¤**ã€‚åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæ„å‘³ç€ç»„ä»¶çš„æ¯ä¸€æ¬¡æ›´æ–°éƒ½ä¼šåˆ›å»ºæ–°çš„è®¢é˜…ã€‚

çœ‹å®Œï¼Œè®©æˆ‘ä»¬å‡è®¾ï¼š

* ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶ `props = { id: 10 }`
* ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶`props = { id: 20 }`

ä½ å¾ˆæœ‰å¯èƒ½è®¤ä¸ºå‘ç”Ÿäº†ä¸‹é¢çš„äº‹ï¼š

* React æ¸…é™¤äº† `{id: 10}`çš„effectã€‚
* React æ¸²æŸ“`{id: 20}`çš„UIã€‚
* React è¿è¡Œ`{id: 20}`çš„effectã€‚

å…¶å®ï¼Œåˆšçœ‹å®Œå®˜æ–¹æ–‡æ¡£çš„è§£é‡Šçš„æˆ‘ä¹Ÿæ˜¯è¿™ä¹ˆè®¤ä¸ºçš„ğŸ˜‚ã€‚

ä½†äº‹å®å¹¶éå¦‚æ­¤ï¼ŒDanå¦‚æ˜¯è¯´ã€‚

> Reactåªä¼šåœ¨[æµè§ˆå™¨ç»˜åˆ¶](https://medium.com/@dan_abramov/this-benchmark-is-indeed-flawed-c3d6b5b6f97f)åè¿è¡Œeffectsã€‚è¿™ä½¿å¾—ä½ çš„åº”ç”¨æ›´æµç•…å› ä¸ºå¤§å¤šæ•°effectså¹¶ä¸ä¼šé˜»å¡å±å¹•çš„æ›´æ–°ã€‚Effectçš„æ¸…é™¤åŒæ ·è¢«å»¶è¿Ÿäº†ã€‚**ä¸Šä¸€æ¬¡çš„effectä¼šåœ¨é‡æ–°æ¸²æŸ“åè¢«æ¸…é™¤ã€‚**

å®é™…å‘ç”Ÿçš„äº‹æ˜¯è¿™æ ·çš„ï¼š

- **React æ¸²æŸ“`{id: 20}`çš„UIã€‚**
- æµè§ˆå™¨ç»˜åˆ¶ã€‚æˆ‘ä»¬åœ¨å±å¹•ä¸Šçœ‹åˆ°`{id: 20}`çš„UIã€‚
- **React æ¸…é™¤`{id: 10}`çš„effectã€‚**
- React è¿è¡Œ`{id: 20}`çš„effectã€‚

è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸èƒ½æ˜¯æˆ‘ä»¬æå‡ºçš„ç¬¬ä¸€ç§å¯èƒ½å‘¢ï¼Ÿå¦‚æœæ¸…é™¤ä¸Šä¸€æ¬¡çš„effectå‘ç”Ÿåœ¨propså˜æˆ`{id: 20}`ä¹‹åï¼Œé‚£å®ƒä¸ºä»€ä¹ˆè¿˜èƒ½â€œçœ‹åˆ°â€æ—§çš„`{id: 10}`ï¼Ÿç­”æ¡ˆéšè—åœ¨å‰æ–‡ã€‚

> *ç»„ä»¶å†…çš„æ¯ä¸€ä¸ªå‡½æ•°ï¼ˆåŒ…æ‹¬äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œeffectsï¼Œå®šæ—¶å™¨æˆ–è€…APIè°ƒç”¨ç­‰ç­‰ï¼‰ä¼šæ•è·å®šä¹‰å®ƒä»¬çš„é‚£æ¬¡æ¸²æŸ“ä¸­çš„propså’Œstateã€‚*

effectçš„æ¸…é™¤å¹¶ä¸ä¼šè¯»å–æœ€æ–°çš„propsï¼Œå®ƒåªèƒ½è¯»å–åˆ°å®ƒé‚£æ¬¡æ¸²æŸ“ä¸­çš„propså€¼ã€‚

è‡³äºä¸ºä»€ä¹ˆä¸èƒ½æ˜¯ç¬¬ä¸€ç§å¯èƒ½ï¼Œç¬”è€…ç°åœ¨è¿˜ä¸æ˜¯å¾ˆæ¸…æ¥šğŸ˜‚ã€‚

*ï¼ˆå¯èƒ½æ˜¯ä¸ºäº†é¿å… <u>effectæ¸…é™¤åä¸å†æ¬¡è¿è¡Œeffectä¹‹é—´é€ æˆçš„ç©ºæŒ¡</u> å¯èƒ½å¼•å‘çš„é—®é¢˜ï¼Ÿï¼‰*

## å†™åœ¨æœ€å

çœ‹åˆ°è¿™é‡Œï¼Œä½ ä¹Ÿè®¸ä¼šå‘ç°è¿™ç¯‡æ–‡ç« å«åšâ€œuseEffectå®Œå…¨æŒ‡å—â€æˆ–è®¸æ›´åŠ åˆé€‚ã€‚
è¿™æ˜¯å¯¹çš„ï¼Œå› ä¸ºæˆ‘ä¹Ÿè¿™ä¹ˆè§‰å¾—ğŸ˜‚ã€‚ï¼ˆæœ‰ç‚¹æ ‡é¢˜å…šäº†å±äºæ˜¯ï¼‰
ä½†æˆ‘è¿˜æ˜¯åšæŒä½¿ç”¨ç°åœ¨è¿™ä¸ªæ ‡é¢˜ï¼Œå› ä¸ºæˆ‘çš„ç¡®ä»ä¸­é¢†æ‚Ÿåˆ°ä¸€äº›ä¹‹å‰æœªæ›¾ç†è§£çš„React Hookså·¥ä½œåŸç†ã€‚

---
æœ€åï¼Œå¦‚æœä½ è¿˜æ˜¯çœ‹ä¸æ‡‚è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘æ¨èä½ å»çœ‹Dançš„[useEffect å®Œæ•´æŒ‡å—](https://overreacted.io/zh-hans/a-complete-guide-to-useeffect/)ï¼Œå†™å¾—éå¸¸å¥½ã€‚
å¸Œæœ›ä½ ä¹Ÿèƒ½åœ¨çœ‹å®Œä¹‹åæƒŠå‘¼â€œç´¢å˜šæ–¯å†…â€~~ğŸ˜Š

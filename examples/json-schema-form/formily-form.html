<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formily v2 ä½ä»£ç è¡¨å•å¹³å°</title>
    <!-- å¼•å…¥ Formily å’Œç›¸å…³ä¾èµ– -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@formily/core@2.x/dist/formily.core.umd.development.js"></script>
    <script src="https://unpkg.com/@formily/react@2.x/dist/formily.react.umd.development.js"></script>
    <script src="https://unpkg.com/@formily/antd@2.x/dist/formily.antd.umd.development.js"></script>
    <script src="https://unpkg.com/antd@4/dist/antd.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/antd@4/dist/antd.min.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: #f5f5f5;
      }

      .platform-container {
        display: flex;
        height: 100vh;
      }

      .component-panel {
        width: 280px;
        background: white;
        border-right: 1px solid #e8e8e8;
        padding: 16px;
        overflow-y: auto;
      }

      .editor-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
      }

      .preview-panel {
        width: 400px;
        background: white;
        border-left: 1px solid #e8e8e8;
        padding: 16px;
        overflow-y: auto;
      }

      .panel-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 16px;
        color: #333;
      }

      .component-item {
        padding: 12px;
        margin-bottom: 8px;
        background: #fafafa;
        border: 1px dashed #d9d9d9;
        border-radius: 4px;
        cursor: move;
        transition: all 0.3s;
      }

      .component-item:hover {
        border-color: #1890ff;
        background: #f0f8ff;
      }

      .design-area {
        flex: 1;
        padding: 20px;
        border: 1px dashed #d9d9d9;
        margin: 16px;
        border-radius: 6px;
        min-height: 500px;
      }

      .toolbar {
        padding: 12px 16px;
        border-bottom: 1px solid #e8e8e8;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .schema-editor {
        height: 300px;
        border: 1px solid #d9d9d9;
        border-radius: 4px;
        margin-top: 16px;
      }

      .field-properties {
        margin-top: 16px;
      }

      .logic-panel {
        margin-top: 16px;
      }

      .empty-prompt {
        text-align: center;
        color: #999;
        padding: 40px 0;
      }

      .component-icon {
        margin-right: 8px;
        font-size: 16px;
      }
    </style>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useRef, useEffect } = React
      const {
        Form,
        Input,
        Select,
        Button,
        Switch,
        Radio,
        Checkbox,
        InputNumber,
        DatePicker,
        Row,
        Col,
        Divider,
        Card,
        Collapse,
        message,
        Modal,
        Tabs,
        Space,
        Tree,
      } = antd
      const { Option } = Select
      const { Panel } = Collapse
      const { TabPane } = Tabs
      const { TreeNode } = Tree

      // Formily æ ¸å¿ƒ
      const { createForm, onFieldValueChange, onFieldInit, onFieldMount } = FormilyCore
      const {
        FormProvider,
        FormConsumer,
        Field,
        useForm,
        useField,
        observer,
        RecursionField,
        SchemaField,
      } = FormilyReact
      const {
        FormItem,
        FormLayout,
        Input: FormilyInput,
        Select: FormilySelect,
        Radio: FormilyRadio,
        Checkbox: FormilyCheckbox,
        NumberPicker: FormilyNumber,
        DatePicker: FormilyDate,
        Switch: FormilySwitch,
        FormTab,
        FormCollapse,
        ArrayCards,
        ArrayTable,
      } = FormilyAntd

      // 1. è¡¨å•ç»„ä»¶åº“å£°æ˜
      const FormComponentLibrary = {
        // åŸºç¡€ç»„ä»¶
        Input: {
          component: FormilyInput,
          defaultProps: {
            placeholder: 'è¯·è¾“å…¥',
          },
          icon: 'ğŸ“',
          name: 'è¾“å…¥æ¡†',
        },
        TextArea: {
          component: FormilyInput,
          defaultProps: {
            placeholder: 'è¯·è¾“å…¥',
            type: 'textarea',
          },
          icon: 'ğŸ“„',
          name: 'å¤šè¡Œæ–‡æœ¬',
        },
        Select: {
          component: FormilySelect,
          defaultProps: {
            placeholder: 'è¯·é€‰æ‹©',
          },
          icon: 'ğŸ”½',
          name: 'ä¸‹æ‹‰é€‰æ‹©',
        },
        Radio: {
          component: FormilyRadio.Group,
          defaultProps: {},
          icon: 'â­•',
          name: 'å•é€‰æ¡†ç»„',
        },
        Checkbox: {
          component: FormilyCheckbox.Group,
          defaultProps: {},
          icon: 'â˜‘ï¸',
          name: 'å¤é€‰æ¡†ç»„',
        },
        Number: {
          component: FormilyNumber,
          defaultProps: {
            placeholder: 'è¯·è¾“å…¥æ•°å­—',
          },
          icon: 'ğŸ”¢',
          name: 'æ•°å­—è¾“å…¥',
        },
        Date: {
          component: FormilyDate,
          defaultProps: {
            placeholder: 'è¯·é€‰æ‹©æ—¥æœŸ',
          },
          icon: 'ğŸ“…',
          name: 'æ—¥æœŸé€‰æ‹©',
        },
        Switch: {
          component: FormilySwitch,
          defaultProps: {},
          icon: 'ğŸ”˜',
          name: 'å¼€å…³',
        },

        // å¸ƒå±€ç»„ä»¶
        FormLayout: {
          component: FormLayout,
          defaultProps: {
            layout: 'vertical',
          },
          icon: 'ğŸ“',
          name: 'è¡¨å•å¸ƒå±€',
        },
        FormItem: {
          component: FormItem,
          defaultProps: {},
          icon: 'ğŸ“¦',
          name: 'è¡¨å•é¡¹',
        },
      }

      // 2. è¡¨å•ç¼–è¾‘å™¨ç»„ä»¶
      const FormEditor = () => {
        const [schema, setSchema] = useState({
          type: 'object',
          properties: {},
        })

        const [selectedField, setSelectedField] = useState(null)
        const [previewForm] = useState(() => createForm())
        const [logicModalVisible, setLogicModalVisible] = useState(false)

        // æ·»åŠ å­—æ®µåˆ°è¡¨å•
        const addFieldToSchema = (fieldType, fieldConfig = {}) => {
          const fieldId = `field_${Date.now()}`
          const componentConfig = FormComponentLibrary[fieldType]

          const newField = {
            type: 'string',
            title: fieldConfig.title || `${componentConfig.name}_${Date.now()}`,
            'x-component': fieldType,
            'x-component-props': {
              ...componentConfig.defaultProps,
              ...fieldConfig.props,
            },
            'x-decorator': 'FormItem',
            'x-decorator-props': {
              tooltip: fieldConfig.tooltip,
            },
          }

          // å¤„ç†é€‰é¡¹å‹ç»„ä»¶
          if (['Select', 'Radio', 'Checkbox'].includes(fieldType)) {
            newField.enum = fieldConfig.options || [
              { label: 'é€‰é¡¹1', value: 'option1' },
              { label: 'é€‰é¡¹2', value: 'option2' },
            ]
          }

          // æ·»åŠ è”åŠ¨è§„åˆ™
          if (fieldConfig.reactions) {
            newField['x-reactions'] = fieldConfig.reactions
          }

          const newSchema = {
            ...schema,
            properties: {
              ...schema.properties,
              [fieldId]: newField,
            },
          }

          setSchema(newSchema)
          setSelectedField(fieldId)
        }

        // æ›´æ–°å­—æ®µå±æ€§
        const updateFieldProperties = (fieldId, updates) => {
          const newSchema = { ...schema }

          if (newSchema.properties[fieldId]) {
            Object.keys(updates).forEach((key) => {
              if (key === 'props') {
                newSchema.properties[fieldId]['x-component-props'] = {
                  ...newSchema.properties[fieldId]['x-component-props'],
                  ...updates[key],
                }
              } else if (key === 'decoratorProps') {
                newSchema.properties[fieldId]['x-decorator-props'] = {
                  ...newSchema.properties[fieldId]['x-decorator-props'],
                  ...updates[key],
                }
              } else {
                newSchema.properties[fieldId][key] = updates[key]
              }
            })

            setSchema(newSchema)
          }
        }

        // åˆ é™¤å­—æ®µ
        const deleteField = (fieldId) => {
          const newSchema = { ...schema }
          delete newSchema.properties[fieldId]
          setSchema(newSchema)

          if (selectedField === fieldId) {
            setSelectedField(null)
          }
        }

        // ç”Ÿæˆ Markup Schema
        const generateMarkupSchema = () => {
          return JSON.stringify(schema, null, 2)
        }

        // ä» Markup Schema åŠ è½½
        const loadFromMarkupSchema = (markupSchema) => {
          try {
            const parsedSchema = JSON.parse(markupSchema)
            setSchema(parsedSchema)
            message.success('Schema åŠ è½½æˆåŠŸ')
          } catch (error) {
            message.error('Schema æ ¼å¼é”™è¯¯')
          }
        }

        // æ·»åŠ è”åŠ¨è§„åˆ™
        const addReaction = (fieldId, reaction) => {
          const field = schema.properties[fieldId]
          if (field) {
            const existingReactions = field['x-reactions'] || []
            const newReactions = [...existingReactions, reaction]

            updateFieldProperties(fieldId, {
              'x-reactions': newReactions,
            })
          }
        }

        return (
          <div className="platform-container">
            {/* å·¦ä¾§ç»„ä»¶é¢æ¿ */}
            <div className="component-panel">
              <div className="panel-title">ç»„ä»¶åº“</div>
              <div>
                {Object.entries(FormComponentLibrary).map(([key, config]) => (
                  <div key={key} className="component-item" onClick={() => addFieldToSchema(key)}>
                    <span className="component-icon">{config.icon}</span>
                    {config.name}
                  </div>
                ))}
              </div>

              <Divider />

              <div className="panel-title">è¡¨å•ç»“æ„</div>
              <FormTree
                schema={schema}
                selectedField={selectedField}
                onSelectField={setSelectedField}
              />
            </div>

            {/* ä¸­é—´è®¾è®¡åŒºåŸŸ */}
            <div className="editor-panel">
              <div className="toolbar">
                <Space>
                  <Button
                    type="primary"
                    onClick={() => {
                      const markup = generateMarkupSchema()
                      console.log('Markup Schema:', markup)
                      message.success('Schema å·²ç”Ÿæˆåˆ°æ§åˆ¶å°')
                    }}
                  >
                    ç”Ÿæˆ Markup Schema
                  </Button>
                  <Button
                    onClick={() => {
                      const markup = prompt('è¯·è¾“å…¥ Markup Schema:')
                      if (markup) {
                        loadFromMarkupSchema(markup)
                      }
                    }}
                  >
                    åŠ è½½ Markup Schema
                  </Button>
                </Space>

                <Button
                  type="dashed"
                  onClick={() => setLogicModalVisible(true)}
                  disabled={!selectedField}
                >
                  é…ç½®è”åŠ¨é€»è¾‘
                </Button>
              </div>

              <div className="design-area">
                {Object.keys(schema.properties).length > 0 ? (
                  <FormProvider form={previewForm}>
                    <SchemaField schema={schema} />
                  </FormProvider>
                ) : (
                  <div className="empty-prompt">
                    <p>ä»å·¦ä¾§ç‚¹å‡»ç»„ä»¶æ·»åŠ åˆ°è¡¨å•</p>
                    <p>æˆ–åŠ è½½å·²æœ‰çš„ Markup Schema</p>
                  </div>
                )}
              </div>
            </div>

            {/* å³ä¾§å±æ€§é¢æ¿ */}
            <div className="preview-panel">
              <div className="panel-title">
                {selectedField
                  ? `å±æ€§è®¾ç½® - ${schema.properties[selectedField]?.title}`
                  : 'å±æ€§è®¾ç½®'}
              </div>

              {selectedField ? (
                <FieldProperties
                  field={schema.properties[selectedField]}
                  fieldId={selectedField}
                  onUpdate={updateFieldProperties}
                  onDelete={deleteField}
                />
              ) : (
                <div className="empty-prompt">
                  <p>è¯·é€‰æ‹©è¡¨å•å­—æ®µè¿›è¡Œé…ç½®</p>
                </div>
              )}

              <Divider />

              <div className="panel-title">Schema é¢„è§ˆ</div>
              <pre className="schema-editor">{generateMarkupSchema()}</pre>
            </div>

            {/* è”åŠ¨é€»è¾‘é…ç½®æ¨¡æ€æ¡† */}
            <LogicConfigModal
              visible={logicModalVisible}
              onCancel={() => setLogicModalVisible(false)}
              fieldId={selectedField}
              schema={schema}
              onAddReaction={addReaction}
            />
          </div>
        )
      }

      // è¡¨å•æ ‘ç»„ä»¶
      const FormTree = observer(({ schema, selectedField, onSelectField }) => {
        const renderTreeNodes = (properties) => {
          return Object.entries(properties).map(([key, field]) => (
            <TreeNode
              key={key}
              title={
                <div onClick={() => onSelectField(key)}>
                  <span
                    style={{
                      fontWeight: selectedField === key ? 'bold' : 'normal',
                      color: selectedField === key ? '#1890ff' : '#333',
                    }}
                  >
                    {field.title || key}
                  </span>
                </div>
              }
            />
          ))
        }

        return (
          <Tree selectedKeys={[selectedField]} defaultExpandAll>
            {renderTreeNodes(schema.properties || {})}
          </Tree>
        )
      })

      // å­—æ®µå±æ€§é…ç½®ç»„ä»¶
      const FieldProperties = observer(({ field, fieldId, onUpdate, onDelete }) => {
        const [form] = Form.useForm()

        useEffect(() => {
          form.setFieldsValue({
            title: field.title,
            placeholder: field['x-component-props']?.placeholder,
            tooltip: field['x-decorator-props']?.tooltip,
          })
        }, [field, form])

        const handleValuesChange = (changedValues, allValues) => {
          const updates = {}

          if ('title' in changedValues) {
            updates.title = changedValues.title
          }

          if ('placeholder' in changedValues) {
            updates.props = { placeholder: changedValues.placeholder }
          }

          if ('tooltip' in changedValues) {
            updates.decoratorProps = { tooltip: changedValues.tooltip }
          }

          if (Object.keys(updates).length > 0) {
            onUpdate(fieldId, updates)
          }
        }

        return (
          <div className="field-properties">
            <Form form={form} layout="vertical" onValuesChange={handleValuesChange}>
              <Form.Item label="å­—æ®µæ ‡é¢˜" name="title">
                <Input />
              </Form.Item>

              <Form.Item label="å ä½æ–‡æœ¬" name="placeholder">
                <Input />
              </Form.Item>

              <Form.Item label="æç¤ºä¿¡æ¯" name="tooltip">
                <Input />
              </Form.Item>

              {/* é€‰é¡¹é…ç½® */}
              {(field['x-component'] === 'Select' ||
                field['x-component'] === 'Radio' ||
                field['x-component'] === 'Checkbox') && (
                <OptionsConfig field={field} fieldId={fieldId} onUpdate={onUpdate} />
              )}

              <Form.Item>
                <Button type="primary" danger onClick={() => onDelete(fieldId)} block>
                  åˆ é™¤å­—æ®µ
                </Button>
              </Form.Item>
            </Form>
          </div>
        )
      })

      // é€‰é¡¹é…ç½®ç»„ä»¶
      const OptionsConfig = observer(({ field, fieldId, onUpdate }) => {
        const [options, setOptions] = useState(field.enum || [])

        const addOption = () => {
          const newOptions = [
            ...options,
            { label: `é€‰é¡¹${options.length + 1}`, value: `option${options.length + 1}` },
          ]
          setOptions(newOptions)
          onUpdate(fieldId, { enum: newOptions })
        }

        const updateOption = (index, key, value) => {
          const newOptions = [...options]
          newOptions[index][key] = value
          setOptions(newOptions)
          onUpdate(fieldId, { enum: newOptions })
        }

        const deleteOption = (index) => {
          const newOptions = options.filter((_, i) => i !== index)
          setOptions(newOptions)
          onUpdate(fieldId, { enum: newOptions })
        }

        return (
          <div>
            <Divider>é€‰é¡¹é…ç½®</Divider>
            {options.map((option, index) => (
              <div key={index} style={{ marginBottom: 8 }}>
                <Row gutter={8}>
                  <Col span={10}>
                    <Input
                      value={option.label}
                      onChange={(e) => updateOption(index, 'label', e.target.value)}
                      placeholder="æ˜¾ç¤ºæ–‡æœ¬"
                    />
                  </Col>
                  <Col span={10}>
                    <Input
                      value={option.value}
                      onChange={(e) => updateOption(index, 'value', e.target.value)}
                      placeholder="å€¼"
                    />
                  </Col>
                  <Col span={4}>
                    <Button danger size="small" onClick={() => deleteOption(index)}>
                      åˆ é™¤
                    </Button>
                  </Col>
                </Row>
              </div>
            ))}
            <Button type="dashed" onClick={addOption} block>
              + æ·»åŠ é€‰é¡¹
            </Button>
          </div>
        )
      })

      // è”åŠ¨é€»è¾‘é…ç½®æ¨¡æ€æ¡†
      const LogicConfigModal = observer(({ visible, onCancel, fieldId, schema, onAddReaction }) => {
        const [form] = Form.useForm()
        const [triggerType, setTriggerType] = useState('valueChange')

        const handleSubmit = () => {
          form.validateFields().then((values) => {
            const reaction = {
              // æ ¹æ®è§¦å‘ç±»å‹æ„å»ºä¸åŒçš„è”åŠ¨è§„åˆ™
              [triggerType === 'valueChange' ? 'when' : 'target']: values.condition,
              fulfill: {
                state:
                  values.action === 'show'
                    ? {
                        display: 'visible',
                      }
                    : values.action === 'hide'
                      ? {
                          display: 'none',
                        }
                      : {
                          value: values.setValue,
                        },
              },
            }

            onAddReaction(fieldId, reaction)
            message.success('è”åŠ¨è§„åˆ™æ·»åŠ æˆåŠŸ')
            onCancel()
            form.resetFields()
          })
        }

        return (
          <Modal
            title="é…ç½®è”åŠ¨é€»è¾‘"
            visible={visible}
            onCancel={onCancel}
            onOk={handleSubmit}
            width={600}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="è§¦å‘ç±»å‹" name="triggerType" initialValue="valueChange">
                <Select onChange={setTriggerType}>
                  <Option value="valueChange">å€¼å˜åŒ–</Option>
                  <Option value="visible">æ˜¾ç¤º/éšè—</Option>
                </Select>
              </Form.Item>

              <Form.Item label="è§¦å‘æ¡ä»¶" name="condition">
                <Input placeholder="ä¾‹å¦‚: {{$self.value === 'show'}}" />
              </Form.Item>

              <Form.Item label="æ‰§è¡ŒåŠ¨ä½œ" name="action">
                <Select>
                  <Option value="show">æ˜¾ç¤ºå­—æ®µ</Option>
                  <Option value="hide">éšè—å­—æ®µ</Option>
                  <Option value="setValue">è®¾ç½®å€¼</Option>
                </Select>
              </Form.Item>

              <Form.Item
                label="è®¾ç½®çš„å€¼"
                name="setValue"
                style={{ display: form.getFieldValue('action') === 'setValue' ? 'block' : 'none' }}
              >
                <Input placeholder="è¯·è¾“å…¥è¦è®¾ç½®çš„å€¼" />
              </Form.Item>
            </Form>

            <Divider />

            <div>
              <h4>è”åŠ¨è§„åˆ™ç¤ºä¾‹:</h4>
              <pre>{`{
  "when": "{{$self.value === 'show'}}",
  "fulfill": {
    "state": {
      "display": "visible"
    }
  }
}`}</pre>
            </div>
          </Modal>
        )
      })

      // ä¸»åº”ç”¨ç»„ä»¶
      const App = () => {
        return (
          <div>
            <div
              style={{
                background: '#001529',
                color: 'white',
                padding: '16px',
                textAlign: 'center',
                fontSize: '18px',
                fontWeight: 'bold',
              }}
            >
              Formily v2 ä½ä»£ç è¡¨å•å¹³å°
            </div>
            <FormEditor />
          </div>
        )
      }

      ReactDOM.render(<App />, document.getElementById('root'))
    </script>
  </body>
</html>
